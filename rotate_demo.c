// 256x256ドット8ビット色BMP画像ファイル回転拡大表示プログラム
// 拡大縮小回転機能付き液晶出力システム使用
// 解像度 横256×縦216ドット＋上8行
// VRAM容量256×256ドット、8ビットカラー

#include "pico/stdlib.h"
#include "hardware/spi.h"
#include "hardware/pll.h"
#include "hardware/clocks.h"
#include "rotatevideo_lcd.h"
#include "graphlib.h"
#include "ff.h"
#include <string.h>
#include <math.h>

FATFS FatFs;
int button_rotation=0;
unsigned char lcd_align;

//三角関数テーブル（1周256分割、値は256倍）
const short sindata[256]={
	0,6,13,19,25,31,38,44,50,56,62,68,74,80,86,92,
	98,104,109,115,121,126,132,137,142,147,152,157,162,167,172,177,
	181,185,190,194,198,202,206,209,213,216,220,223,226,229,231,234,
	237,239,241,243,245,247,248,250,251,252,253,254,255,255,256,256,
	256,256,256,255,255,254,253,252,251,250,248,247,245,243,241,239,
	237,234,231,229,226,223,220,216,213,209,206,202,198,194,190,185,
	181,177,172,167,162,157,152,147,142,137,132,126,121,115,109,104,
	98,92,86,80,74,68,62,56,50,44,38,31,25,19,13,6,
	0,-6,-13,-19,-25,-31,-38,-44,-50,-56,-62,-68,-74,-80,-86,-92,
	-98,-104,-109,-115,-121,-126,-132,-137,-142,-147,-152,-157,-162,-167,-172,-177,
	-181,-185,-190,-194,-198,-202,-206,-209,-213,-216,-220,-223,-226,-229,-231,-234,
	-237,-239,-241,-243,-245,-247,-248,-250,-251,-252,-253,-254,-255,-255,-256,-256,
	-256,-256,-256,-255,-255,-254,-253,-252,-251,-250,-248,-247,-245,-243,-241,-239,
	-237,-234,-231,-229,-226,-223,-220,-216,-213,-209,-206,-202,-198,-194,-190,-185,
	-181,-177,-172,-167,-162,-158,-153,-147,-142,-137,-132,-126,-121,-115,-109,-104,
	-98,-92,-86,-80,-74,-68,-62,-56,-50,-44,-38,-31,-25,-19,-13,-6
};

// 三角関数マクロ定義
#define Sin(x) sindata[(x)]
#define Cos(x) sindata[((x)+64)&0xff]

// 前回呼び出し時から60分のn秒経過していなければ、それまでウェイト
void wait60thsec(unsigned short n){
	static uint64_t prev_time=0;
	prev_time+=16667*n;
	uint64_t t=to_us_since_boot(get_absolute_time());
	if(t<prev_time) sleep_us(prev_time-t);
	else prev_time=t;
}

// 32x32ドットキャラクターデータ
const unsigned char bmp1[32*32]=
{
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,5,7,0,5,7,7,5,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,6,3,5,7,3,5,2,5,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,5,7,0,7,5,7,6,1,6,5,3,6,1,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,2,5,7,0,7,0,5,7,7,5,7,1,6,1,4,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,5,7,5,7,5,7,7,0,3,0,4,7,7,5,3,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,3,4,3,7,0,7,1,7,5,6,5,7,3,5,0,7,5,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,4,7,5,0,7,7,7,7,0,7,3,5,6,5,7,1,2,7,7,7,
	7,7,7,7,7,7,7,7,7,7,3,5,7,1,6,1,5,7,0,5,7,5,7,0,7,3,4,7,5,7,7,7,
	7,7,7,7,7,7,7,0,3,0,7,2,1,6,3,6,7,5,7,2,5,2,5,7,7,5,7,0,7,7,7,7,
	7,7,7,7,7,7,7,3,6,7,0,7,7,1,3,5,3,0,7,5,7,7,1,7,0,7,1,7,7,0,7,7,
	7,7,7,7,2,0,2,5,3,5,3,6,1,6,0,6,3,4,3,4,3,5,7,0,7,5,7,6,5,7,7,7,
	7,7,7,7,1,7,5,2,6,0,7,1,6,3,7,1,6,3,5,3,7,6,7,5,7,7,1,0,4,3,7,7,
	7,7,5,2,7,2,3,5,3,7,2,7,2,1,2,7,1,6,3,4,5,1,4,3,7,0,4,4,0,4,7,7,
	7,7,7,7,0,3,5,2,7,0,7,0,5,7,0,7,0,3,4,3,2,0,4,0,4,0,4,1,4,7,7,7,
	7,7,2,0,7,7,0,3,0,7,3,1,7,2,7,3,6,1,7,0,4,4,0,4,0,4,5,0,7,7,7,7,
	7,7,5,3,0,7,2,5,2,1,6,2,1,7,0,7,1,6,3,5,3,0,5,0,5,0,4,0,7,7,7,7,
	7,7,7,0,7,0,7,2,1,6,1,7,4,2,1,6,3,0,7,2,7,7,4,0,4,0,7,7,7,7,7,7,
	7,7,7,7,2,3,7,1,6,3,1,6,3,1,7,2,5,2,7,1,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,0,5,2,7,1,6,2,7,7,2,5,3,7,0,0,4,7,7,7,7,7,7,7,7,7,7,7,7,
	7,0,4,0,4,0,4,0,3,5,3,0,3,4,3,6,3,5,0,0,7,7,7,7,0,4,0,5,2,7,7,7,
	1,4,0,4,0,5,0,4,0,2,4,1,4,0,0,1,4,0,4,0,7,7,5,0,4,0,4,0,4,0,7,7,
	7,0,4,1,4,0,4,0,4,7,1,6,0,4,4,4,0,4,4,0,6,7,0,4,0,4,1,4,0,4,0,4,
	7,4,1,4,0,4,1,4,0,0,4,1,4,0,5,0,4,1,0,7,5,0,4,0,4,1,4,0,5,4,0,7,
	7,7,4,0,4,4,4,0,4,3,0,7,0,4,0,4,0,4,7,7,2,5,0,4,0,4,4,4,0,4,1,7,
	7,7,7,4,1,0,4,0,5,7,4,7,7,0,5,0,7,7,7,5,0,4,0,5,0,5,0,0,4,0,7,7,
	7,7,7,7,7,4,1,7,7,7,0,7,7,7,7,7,7,7,7,2,7,7,4,0,4,0,4,5,0,7,7,7,
	7,7,7,7,7,7,7,7,7,7,0,7,7,7,7,7,7,7,0,5,7,7,7,5,0,4,0,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,0,7,7,7,7,7,7,7,4,6,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,0,7,7,7,7,7,7,4,0,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7
};

const unsigned char bmp2[32*32]={
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,2,3,2,3,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,3,2,3,0,3,1,2,3,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,3,2,3,0,3,2,2,3,2,3,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,2,3,7,3,0,3,7,3,0,3,7,7,7,7,7,6,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,3,1,3,2,7,7,7,7,2,3,2,3,7,4,4,4,4,4,6,7,7,7,7,7,
	7,7,7,7,7,7,7,7,2,3,2,0,7,7,7,3,1,0,3,0,4,4,4,6,4,4,4,7,7,7,7,7,
	7,7,7,7,7,7,7,7,3,0,3,3,7,7,7,3,2,3,3,6,4,6,4,4,4,6,4,4,7,7,7,7,
	7,7,7,7,7,7,7,7,7,3,2,3,3,0,3,7,3,2,2,4,4,4,6,4,4,4,6,4,6,7,7,7,
	7,7,7,7,7,7,7,7,7,2,3,7,2,3,0,2,3,3,1,6,4,4,4,4,6,4,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,1,2,3,0,3,3,3,2,4,4,7,6,4,6,4,4,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,2,3,2,3,7,7,7,7,7,4,4,4,4,6,4,7,7,7,7,7,
	7,7,7,7,7,7,3,2,3,2,3,3,7,5,5,7,7,7,7,7,7,7,4,6,4,4,6,7,7,7,7,7,
	7,7,7,7,7,3,2,3,2,3,2,2,3,6,7,7,7,7,7,7,7,7,7,0,6,4,4,7,7,7,7,7,
	7,7,7,7,3,2,3,3,2,3,2,3,2,3,7,7,7,7,7,7,7,7,7,7,4,4,6,7,7,7,7,7,
	7,7,7,7,2,3,7,3,2,3,7,3,2,3,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,3,2,2,2,7,7,7,7,2,3,2,3,7,7,7,5,1,1,5,1,7,7,7,7,7,7,7,7,7,
	7,7,7,7,3,3,2,3,7,7,3,2,3,2,7,7,7,5,1,5,5,1,5,1,5,7,7,7,7,7,7,7,
	7,7,7,3,2,3,2,7,7,7,7,2,3,2,3,7,5,1,5,1,1,5,1,5,1,5,7,7,7,7,7,7,
	7,7,7,7,2,3,3,3,2,3,3,3,2,3,7,7,1,5,7,7,5,5,7,5,1,5,7,7,7,7,7,7,
	7,7,7,7,3,2,3,2,3,2,2,3,3,2,5,5,1,1,5,7,7,7,7,1,5,1,5,7,7,7,7,7,
	7,7,7,7,7,3,2,3,2,3,3,2,3,7,7,1,5,5,5,5,7,7,5,5,5,1,7,7,7,7,7,7,
	7,7,7,7,7,4,0,2,3,2,2,2,4,6,7,7,5,1,1,7,7,7,7,1,1,1,5,7,7,7,7,7,
	7,7,7,7,6,4,7,4,4,4,4,4,4,4,7,5,1,5,7,5,5,5,7,5,5,5,7,7,7,7,7,7,
	7,7,7,7,7,7,6,4,6,4,4,6,4,4,4,7,5,1,5,1,5,1,1,5,1,5,7,7,7,7,7,7,
	7,7,7,7,7,7,4,4,4,6,4,4,4,6,4,7,7,5,1,5,1,5,5,1,5,7,7,7,7,7,7,7,
	7,7,7,7,7,7,6,4,6,4,4,6,7,4,4,7,7,7,7,5,1,5,1,5,6,7,7,7,7,7,7,7,
	7,7,7,7,7,7,4,4,4,4,0,7,7,7,7,7,7,7,7,7,4,4,6,6,4,4,7,7,7,7,7,7,
	7,7,7,7,7,7,6,4,6,4,6,7,7,7,7,7,7,7,7,7,7,4,4,4,6,7,7,7,7,7,7,7,
	7,7,7,7,7,7,6,4,4,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7
};

const unsigned char bmp3[32*32]={
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,6,6,2,7,7,6,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,6,6,7,3,6,6,7,7,2,6,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,6,6,0,6,6,6,6,0,6,6,7,7,6,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,6,7,0,6,6,6,2,6,2,6,6,6,2,4,6,2,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,6,6,6,2,6,6,6,6,6,0,6,6,2,6,6,6,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,3,6,6,2,6,2,0,2,0,2,0,2,6,6,2,6,1,6,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,5,2,6,6,2,0,6,0,6,0,6,0,6,2,6,6,6,6,7,7,7,7,7,7,7,
	7,7,7,7,7,7,6,6,6,2,6,0,6,0,2,1,2,0,6,0,6,6,2,6,3,7,7,7,7,7,7,7,
	7,7,7,7,7,7,2,6,6,6,0,3,0,6,0,6,2,5,2,0,2,6,6,0,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,6,2,6,2,4,2,2,0,6,0,2,0,6,0,2,6,6,6,0,7,7,7,7,7,7,
	7,7,7,7,7,7,4,2,6,6,0,0,6,0,7,0,2,0,6,2,0,6,6,6,6,7,7,7,7,7,7,7,
	7,7,7,7,7,2,6,6,6,2,0,6,0,2,0,2,4,2,0,5,2,6,2,2,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,2,4,6,2,0,7,0,6,2,0,7,2,0,6,6,6,6,2,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,2,6,6,2,0,2,2,4,2,0,4,2,2,2,6,6,6,6,7,7,7,7,7,7,
	7,7,7,7,7,7,6,6,6,6,6,2,6,0,4,3,4,2,2,6,6,6,6,1,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,2,5,2,6,6,0,6,2,0,2,4,6,2,6,6,6,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,6,6,2,6,6,6,6,6,2,6,6,2,6,2,6,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,2,6,7,6,2,6,2,6,6,2,6,7,7,5,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,2,4,7,1,6,6,1,6,6,0,7,6,0,5,2,0,0,1,6,7,7,7,7,7,
	7,7,7,7,7,7,4,0,4,0,0,4,2,4,7,7,2,7,5,0,4,0,4,4,6,4,0,7,7,7,7,7,
	7,7,7,7,7,7,7,0,1,4,0,4,0,0,6,7,0,0,0,4,0,4,0,0,0,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,4,0,4,0,5,4,0,5,6,4,0,0,0,5,0,5,4,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,1,4,0,6,0,6,0,1,7,4,1,6,0,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,2,7,0,7,7,0,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,4,3,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,0,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,0,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,0,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,0,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,0,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7
};

const unsigned char bmp4[32*32]={
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,4,6,4,7,4,7,7,7,7,7,7,7,7,7,7,2,2,2,2,2,7,7,7,7,7,7,7,7,7,7,7,
	6,4,0,4,0,4,0,4,4,5,6,2,2,2,2,2,2,2,2,2,2,2,6,7,7,7,7,7,6,5,6,5,
	7,4,7,4,4,5,4,0,4,2,2,6,2,2,2,2,2,2,2,2,2,2,2,7,7,4,4,0,4,4,0,6,
	7,4,0,7,0,6,2,7,2,6,2,2,7,6,2,2,2,0,2,2,2,2,2,2,6,0,4,4,2,4,6,5,
	7,3,4,4,4,2,6,2,2,2,2,6,2,2,2,2,2,2,2,2,2,2,2,2,2,5,4,5,4,5,0,6,
	7,4,4,0,7,2,2,6,2,6,7,2,2,2,2,2,2,2,3,2,2,2,2,6,2,6,0,4,0,6,4,7,
	7,7,4,4,2,6,2,2,6,2,2,2,2,2,2,2,0,2,2,0,2,2,2,2,2,2,5,4,4,1,4,7,
	7,7,1,4,2,2,2,6,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,6,0,4,4,4,7,
	7,7,7,4,2,6,2,2,6,2,2,7,0,2,0,2,2,2,2,2,0,2,2,2,2,2,3,4,5,4,0,7,
	7,7,7,0,2,2,2,6,2,2,2,0,2,2,2,2,2,2,3,2,2,2,2,2,2,6,4,4,0,4,7,7,
	7,7,7,7,2,2,2,2,2,0,2,2,0,2,2,2,0,2,6,2,2,2,2,2,2,2,3,4,4,0,7,7,
	7,7,7,7,2,2,7,2,2,2,2,2,2,2,0,2,2,2,2,2,7,2,2,2,2,2,0,0,4,5,7,7,
	7,7,7,7,2,2,2,2,2,2,2,2,2,0,2,2,0,2,2,2,2,2,0,2,2,0,2,4,5,7,7,7,
	7,7,7,7,2,2,2,2,2,2,2,2,3,6,2,2,6,2,2,2,6,2,2,2,0,2,4,5,7,7,7,7,
	7,7,7,7,2,2,2,2,2,2,2,2,2,2,6,2,2,2,6,2,3,2,2,2,2,5,7,7,7,7,7,7,
	7,7,7,7,0,2,2,2,2,2,2,2,2,2,2,2,6,2,2,2,2,2,2,0,2,7,7,7,7,7,7,7,
	7,7,7,5,2,2,0,2,2,2,6,2,6,2,2,6,2,2,7,2,2,2,2,2,2,7,7,7,7,7,7,7,
	7,7,7,4,4,4,2,2,2,2,2,2,2,2,6,2,2,6,2,0,2,2,0,2,7,7,7,7,7,7,7,7,
	7,7,7,0,4,5,2,2,2,2,2,2,2,2,2,2,6,2,2,2,2,2,2,2,2,7,7,7,7,7,7,7,
	7,7,7,4,0,4,5,0,2,0,2,2,2,2,6,3,2,2,2,2,2,2,2,2,7,7,7,7,7,7,7,7,
	7,7,4,0,5,4,4,2,2,2,2,0,2,2,2,2,2,2,2,2,2,7,7,7,7,7,7,7,7,7,7,7,
	7,7,4,6,4,0,4,5,0,2,4,2,0,2,2,2,2,2,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,5,0,4,5,0,4,4,5,4,5,4,5,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,4,7,4,6,4,4,4,0,4,0,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,6,4,0,4,0,5,0,4,5,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,4,0,6,5,6,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,6,5,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7
};

const unsigned char bmp5[32*32]={
	7,7,7,7,7,7,7,7,7,7,7,7,7,2,2,2,2,2,3,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,2,2,7,2,2,2,2,3,3,2,2,2,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,2,2,2,2,2,2,2,2,2,3,2,2,2,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,2,2,6,2,2,2,6,2,2,2,2,2,2,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,2,2,6,2,2,2,2,6,2,2,2,2,2,2,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,2,2,6,2,2,2,6,2,2,2,2,2,2,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,2,2,6,2,2,2,2,6,2,2,2,2,2,2,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,2,2,2,6,2,2,6,2,2,2,2,2,2,2,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,2,2,2,6,2,2,2,2,2,2,2,2,2,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,2,2,2,2,2,2,6,2,2,2,2,2,2,6,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,6,2,2,2,2,2,2,6,2,2,2,2,2,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,2,2,2,2,2,2,2,2,2,2,2,6,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,2,2,2,2,2,2,2,2,2,2,7,7,7,4,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,2,2,2,2,2,2,2,2,7,7,7,7,0,7,7,7,7,7,7,7,
	7,7,7,7,7,7,5,4,7,7,7,7,7,7,6,0,2,7,7,7,7,7,7,4,4,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,4,7,7,7,7,7,7,7,4,4,7,7,7,7,7,4,4,4,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,4,4,5,7,7,7,7,6,4,6,7,7,7,7,4,4,0,5,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,4,4,4,4,7,7,7,7,4,4,7,7,7,4,4,4,4,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,5,4,4,4,4,7,7,7,4,4,7,7,4,0,4,4,4,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,4,4,4,4,4,4,6,4,6,7,4,4,4,4,0,4,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,4,4,6,4,4,4,4,4,0,4,4,6,4,0,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,4,4,4,4,4,4,4,4,4,4,4,4,4,4,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,4,4,4,6,4,6,4,0,4,4,6,4,4,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,4,4,4,4,4,4,4,4,6,4,4,0,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,4,4,4,6,4,4,4,4,4,4,4,4,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,4,4,4,4,4,4,0,6,4,4,4,4,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,4,4,6,4,4,4,4,4,4,4,0,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,4,4,4,4,0,6,4,4,4,4,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,5,4,4,4,4,4,4,4,0,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,4,4,0,4,4,4,4,5,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,4,4,0,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7
};

// 14x13ドットキャラクターデータ
const unsigned char bmp1413_1[14*13]={
	0,0,0,0,0,2,2,2,2,0,0,0,0,0,
	0,0,0,2,2,2,2,2,2,2,2,0,0,0,
	0,0,2,2,2,2,2,2,2,2,2,2,0,0,
	0,2,7,7,2,2,2,2,7,7,2,2,2,0,
	0,7,7,7,7,2,2,7,7,7,7,2,2,0,
	0,8,8,7,7,2,2,8,8,7,7,2,2,0,
	2,8,8,7,7,2,2,8,8,7,7,2,2,2,
	2,2,7,7,2,2,2,2,7,7,2,2,2,2,
	2,2,2,2,2,2,2,2,2,2,2,2,2,2,
	2,2,2,2,2,2,2,2,2,2,2,2,2,2,
	2,2,2,2,2,2,2,2,2,2,2,2,2,2,
	2,2,2,2,0,2,2,2,2,0,2,2,2,2,
	0,2,2,0,0,0,2,2,0,0,0,2,2,0
};
const unsigned char bmp1413_2[14*13]={
	0,0,0,0,0,5,5,5,5,0,0,0,0,0,
	0,0,0,5,5,5,5,5,5,5,5,0,0,0,
	0,0,5,5,5,5,5,5,5,5,5,5,0,0,
	0,5,7,7,5,5,5,5,7,7,5,5,5,0,
	0,7,7,7,7,5,5,7,7,7,7,5,5,0,
	0,8,8,7,7,5,5,8,8,7,7,5,5,0,
	5,8,8,7,7,5,5,8,8,7,7,5,5,5,
	5,5,7,7,5,5,5,5,7,7,5,5,5,5,
	5,5,5,5,5,5,5,5,5,5,5,5,5,5,
	5,5,5,5,5,5,5,5,5,5,5,5,5,5,
	5,5,5,5,5,5,5,5,5,5,5,5,5,5,
	5,5,0,5,5,5,0,0,5,5,5,0,5,5,
	5,0,0,0,5,5,0,0,5,5,0,0,0,5
};
//demo3用　画面のスクロール、拡大、回転設定
void setvector(int s){
	float th;

	if(s<180) return; //3秒間は通常画面
	s-=180;
	if(s<512){
		//上にスクロール
		vscanstarty+=256;
		return;
	}
	s-=512;
	if(s<512){
		//左にスクロール
		vscanstartx+=256;
		return;
	}
	s-=512;
	if(s<180){
		//拡大
		vscanv1_x=256-s;
		vscanv2_y=256-s;
		vscanstartx=s*50;
		vscanstarty=s*50;
		return;
	}
	s-=180;
	if(s<180){
		//拡大を戻す
		vscanv1_x=256-180+s;
		vscanv2_y=256-180+s;
		vscanstartx=(180-s)*50;
		vscanstarty=(180-s)*50;
		return;
	}
	s-=180;
	if(s<256){
		//単純回転
		th=(float)((s+1)%256)/128.0*3.14159;
		vscanv1_x=(short)(256.0*cos(th));
		vscanv1_y=(short)(256.0*sin(th));
		vscanv2_x=(short)(-256.0*sin(th));
		vscanv2_y=(short)(256.0*cos(th));
		vscanstartx=(short)(256.0*((-128.0*cos(th)+112.0*sin(th))+128));
		vscanstarty=(short)(256.0*((-128.0*sin(th)-112.0*cos(th))+112));
		return;
	}
	s-=256;
	if(s<256){
		//拡大しながら回転
		th=(float)((s+1)%256)/128.0*3.14159;
		vscanv1_x=(short)(256.0*100.0/(s+100.0)*cos(th));
		vscanv1_y=(short)(256.0*100.0/(s+100.0)*sin(th));
		vscanv2_x=(short)(-256.0*100.0/(s+100.0)*sin(th));
		vscanv2_y=(short)(256.0*100.0/(s+100.0)*cos(th));
		vscanstartx=(short)(256.0*(100.0/(s+100.0)*(-128.0*cos(th)+112.0*sin(th))+128));
		vscanstarty=(short)(256.0*(100.0/(s+100.0)*(-128.0*sin(th)-112.0*cos(th))+112));
		return;
	}
	s-=256;
	if(s<256){
		//拡大を戻しながら回転
		th=(float)((s+1)%256)/128.0*3.14159;
		vscanv1_x=(short)(256.0*100.0/(355.0-s)*cos(th));
		vscanv1_y=(short)(256.0*100.0/(355.0-s)*sin(th));
		vscanv2_x=(short)(-256.0*100.0/(355.0-s)*sin(th));
		vscanv2_y=(short)(256.0*100.0/(355.0-s)*cos(th));
		vscanstartx=(short)(256.0*(100.0/(355.0-s)*(-128.0*cos(th)+112.0*sin(th))+128));
		vscanstarty=(short)(256.0*(100.0/(355.0-s)*(-128.0*sin(th)-112.0*cos(th))+112));
		return;
	}
}
int demo3(void){
	int i,j,k;
	unsigned int n;
	unsigned char *ad1,*ad2,tempbuf[VRAM_X];
	int x1,y1,dx1,dy1,old_x1,old_y1;
	int x2,y2,dx2,dy2,old_x2,old_y2;
	int scene;

	//上部にアルファベット表示
	k=0;
	for(i=0;i<=24;i+=8){
		for(j=0;j<=VRAM_X-8;j+=8){
			putfont(j,i,k%16,k%26+'A');
			k++;
		}
	}

	//カラーパターン
	for(i=42;i<54;i++){
		for(j=0;j<256;j++){
			pset(j,i,(256-1-j)/32);
		}
	}
	for(;i<65;i++){
		for(j=0;j<256;j++){
			pset(j,i,(256-1-j)/32+8);
		}
	}

	//32x32キャラクター
	putbmpmn(0,68,32,32,bmp1);
	putbmpmn(32,68,32,32,bmp2);
	putbmpmn(64,68,32,32,bmp3);
	putbmpmn(96,68,32,32,bmp4);
	putbmpmn(128,68,32,32,bmp5);
	putbmpmn(160,68,32,32,bmp1);
	putbmpmn(192,68,32,32,bmp2);
	putbmpmn(224,68,32,32,bmp3);

	//直線
	for(i=0;i<=120;i+=8){
		line(i,102,0,222-i,4);
	}

	//円
	for(i=1;i<16;i++){
		circle(70,160,i*4,i);
	}

	//
	line(134,102,VRAM_X-1,102,7);
	line(134,102,134,VRAM_Y-1,7);
	line(VRAM_X-1,102,VRAM_X-1,VRAM_Y-1,7);
	line(134,VRAM_Y-1,VRAM_X-1,VRAM_Y-1,7);

	//移動キャラクターの設定
	x1=135;
	y1=120;
	old_x1=x1;
	old_y1=y1;
	dx1=1;
	dy1=1;

	x2=140;
	y2=150;
	old_x2=x2;
	old_y2=y2;
	dx2=1;
	dy2=0;
	n=0;
	k=0;
	scene=0;
	while(1){
		//アルファベット部分スクロール
		ad1=VRAM;
		ad2=tempbuf;
		for(i=0;i<VRAM_X;i++) *ad2++=*ad1++;
		ad2=VRAM;
		for(i=0;i<31;i++){
			for(j=0;j<VRAM_X;j++){
				*ad2++=*ad1++;
			}
		}
		ad1=tempbuf;
		for(i=0;i<VRAM_X;i++) *ad2++=*ad1++;

	//カウンタ表示
		if(++k==6){
			k=0;
			printnum(0,32,7,n++);
			if(n==0) printstr(0,32,7,"          ");
		}

	//キャラクターの移動
		clrbmpmn(old_x1,old_y1,14,13);	//移動前のキャラクターの消去
		clrbmpmn(old_x2,old_y2,14,13);	//移動前のキャラクターの消去

		putbmpmn(x1,y1,14,13,bmp1413_1);	//移動後のキャラクターの表示
		putbmpmn(x2,y2,14,13,bmp1413_2);	//移動後のキャラクターの表示

		old_x1=x1;
		old_y1=y1;
		x1+=dx1;
		y1+=dy1;
		if((x1+dx1<135) || (x1+dx1>VRAM_X-1-14)) dx1=-dx1;
		if((y1+dy1<103) || (y1+dy1>VRAM_Y-1-13)) dy1=-dy1;

		old_x2=x2;
		old_y2=y2;
		x2+=dx2;
		y2+=dy2;
		if((x2+dx2<135) || (x2+dx2>VRAM_X-1-14)) dx2=-dx2;
		if((y2+dy2<103) || (y2+dy2>VRAM_Y-1-13)) dy2=-dy2;

		//画面のスクロール、拡大、回転設定
		setvector(scene);
		scene++;
		if(scene==2845) scene=0;

		putlcdall();
		wait60thsec(1);
	}
}
void demo1(){
	uint d,br;
	FIL fpo;

	// BMPファイルを読み込みVRAMに書き込み
	f_open(&fpo,"KUNIKAZE.BMP",FA_READ);
	f_lseek(&fpo,54);
	for(int c=0;c<256;c++){
		f_read(&fpo,&d,4,&br);
		set_palette(c,d&255,(d>>16)&255,(d>>8)&255);
	}
	for(int y=255;y>=0;y--){
		for(int x=0;x<256;x++){
			f_read(&fpo,&d,1,&br);
			pset(x,y,d);
		}
	}
	f_close(&fpo);

	while(1){
		//拡大画面から回転しながら通常サイズに戻す
		for(int x=254;x>=0;x-=2){
			vscanv1_x=50*Cos(x)/(x+50);
			vscanv1_y=50*Sin(x)/(x+50);
			vscanv2_x=-vscanv1_y;
			vscanv2_y=vscanv1_x;
			vscanstartx=50*((int)(-128)*Cos(x)+112*Sin(x))/(x+50)+128*256;
			vscanstarty=50*((int)(-128)*Sin(x)-112*Cos(x))/(x+50)+112*256;
			putlcdall();//液晶画面にVRAMの内容を転送
			wait60thsec(1);
		}
		wait60thsec(180);
		//通常サイズから回転しながら拡大
		for(int x=0;x<256;x+=2){
			vscanv1_x=50*Cos(256-x)/(x+50);
			vscanv1_y=50*Sin(256-x)/(x+50);
			vscanv2_x=-vscanv1_y;
			vscanv2_y=vscanv1_x;
			vscanstartx=50*((int)(-128)*Cos(256-x)+112*Sin(256-x))/(x+50)+128*256;
			vscanstarty=50*((int)(-128)*Sin(256-x)-112*Cos(256-x))/(x+50)+112*256;
			putlcdall();//液晶画面にVRAMの内容を転送
			wait60thsec(1);
		}
	}
}

void demo2(){
	uint d,br;
	FIL fpo;

	// BMPファイルを読み込みVRAMに書き込み
	f_open(&fpo,"NEKOBUS.BMP",FA_READ);
	f_lseek(&fpo,54);
	for(int c=0;c<256;c++){
		f_read(&fpo,&d,4,&br);
		set_palette(c,d&255,(d>>16)&255,(d>>8)&255);
	}
	for(int y=255;y>=0;y--){
		for(int x=0;x<256;x++){
			f_read(&fpo,&d,1,&br);
			pset(x,y,d);
		}
	}
	f_close(&fpo);

	while(1){
		//単純に連続回転
		for(int x=0;x<256;x++){
			vscanv1_x=Cos(x);
			vscanv1_y=Sin(x);
			vscanv2_x=-vscanv1_y;
			vscanv2_y=vscanv1_x;
			vscanstartx=-128*Cos(x)+112*Sin(x)+128*256;
			vscanstarty=-128*Sin(x)-112*Cos(x)+128*256;
			putlcdall();//液晶画面にVRAMの内容を転送
			wait60thsec(1);
		}
	}
}

// MACHIKAP.INI読み込み
void read_ini(void){
	FIL fpo;
	unsigned char str[256];
	// Open INI file
	if (f_open(&fpo,"MACHIKAP.INI",FA_READ)) return;
	// Read each line
	while(f_gets(str,sizeof(str),&fpo)){
		if (!strncmp(str,"LCD90TURN",9) || !strncmp(str,"LCD180TURN",10)) {
			lcd_align|=LCD180TURN;
		} else if (!strncmp(str,"ROTATEBUTTONS",13)) {
			button_rotation=1;
		} else if (!strncmp(str,"NOROTATEBUTTONS",15)) {
			button_rotation=0;
		}
	}
	// Close file
	f_close(&fpo);
}

int main(void){
	// SYSTEM Clock, Peripheral Clockを250MHzに設定
    hw_clear_bits(&clocks_hw->clk[clk_sys].ctrl, CLOCKS_CLK_SYS_CTRL_SRC_BITS);
    while (clocks_hw->clk[clk_sys].selected != 0x1)
        tight_loop_contents();

    pll_init(pll_sys, 1, 1500 * MHZ, 3, 2);
    clock_configure(clk_sys,
                    CLOCKS_CLK_SYS_CTRL_SRC_VALUE_CLKSRC_CLK_SYS_AUX,
                    CLOCKS_CLK_SYS_CTRL_AUXSRC_VALUE_CLKSRC_PLL_SYS,
                    250 * MHZ,
                    250 * MHZ);
    clock_configure(clk_peri,
                    0,
                    CLOCKS_CLK_PERI_CTRL_AUXSRC_VALUE_CLK_SYS,
                    250 * MHZ,
                    250 * MHZ);

    stdio_init_all();

	// 液晶用ポート設定
	// Enable SPI at 64 MHz and connect to GPIOs
	spi_init(LCD_SPICH, 64000 * 1000);
	gpio_set_function(LCD_SPI_RX, GPIO_FUNC_SPI);
	gpio_set_function(LCD_SPI_TX, GPIO_FUNC_SPI);
	gpio_set_function(LCD_SPI_SCK, GPIO_FUNC_SPI);
	
	gpio_init(LCD_CS);
	gpio_put(LCD_CS, 1);
	gpio_set_dir(LCD_CS, GPIO_OUT);
	gpio_init(LCD_DC);
	gpio_put(LCD_DC, 1);
	gpio_set_dir(LCD_DC, GPIO_OUT);
	gpio_init(LCD_RESET);
	gpio_put(LCD_RESET, 1);
	gpio_set_dir(LCD_RESET, GPIO_OUT);

	lcd_align=HORIZONTAL;
	// Read MACHIKAP.INI
	f_mount(&FatFs, "", 0);
	read_ini(); //MACHKAP.INIファイル読み込み
	init_rotateLCD(lcd_align); //グラフィックおよびLCDの初期化

	demo3();
}
